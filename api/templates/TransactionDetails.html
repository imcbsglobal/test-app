{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
        background-color: white;
      }

      .highlight-row {
        background-color: #fff8e1;
      }

      .highlight-text {
        color: #d32f2f;
      }

      .date-input {
        padding: 8px 12px;
        border-radius: 25px;
        border: 1px solid #ff6b6b;
        width: 100%;
        font-size: 16px;
        color: #666;
      }

      .search-button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #ff6b6b;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        cursor: pointer;
      }

      .search-button:hover {
        background-color: #ff5252;
      }

      .table-container {
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid #ffe0e0;
      }

      .table-header {
        background-color: #cbd5e0;
        font-weight: 600;
      }

      .table-row {
        border-bottom: 1px solid #ffe0e0;
        font-size: small;
      }

      .table-cell {
        padding: 12px 15px;
        text-align: center;
      }

      .table-cell:first-child {
        text-align: left;
      }

      .table-cell:nth-child(2) {
        text-align: right;
      }

      .table-cell:nth-child(3) {
        text-align: right;
      }

      .table-cell:last-child {
        text-align: right;
      }

      .dropdown-content {
        max-height: 200px;
        overflow-y: auto;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ff6b6b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background-color: #fee2e2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 12px;
        border-radius: 8px;
        margin: 16px;
        text-align: center;
      }

      .date-picker-input {
        width: 100%;
        border: none;
        background: transparent;
        outline: none;
        color: #666;
      }

      .date-container {
        position: relative;
      }

      .logo-container {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      }

      .stats-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .dashboard-card {
        background: linear-gradient(135deg, #ef4444 0%, #ef4444 100%);
        position: relative;
        overflow: hidden;
      }

      .dashboard-card::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
        border-radius: 50%;
      }

      /* Pagination Styles */
      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .pagination-btn {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        background-color: white;
        color: #4a5568;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 40px;
        text-align: center;
      }

      .pagination-btn:hover:not(:disabled) {
        background-color: #f7fafc;
        border-color: #cbd5e0;
      }

      .pagination-btn.active {
        background-color: #ef4444;
        color: white;
        border-color: #ef4444;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-info {
        font-size: 14px;
        color: #718096;
        margin: 0 16px;
      }

      /* Very light classic colors for each column */
      .col-product {
        background-color: #f0fdf4;
        /* Very light green */
      }

      .col-sales {
        background-color: #fffbeb;
        /* Very light yellow */
      }

      .col-purchase {
        background-color: #fef2f2;
        /* Very light red */
      }

      .col-production {
        background-color: #eff6ff;
        /* Very light blue */
      }

      /* Add this to your existing styles - don't modify anything else */
      .filter-selected {
        color: #ef4444;
        /* Red color matching your theme */
      }

      /* Add these styles to your existing style section */
      .dropdown-search-container {
        padding: 8px;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        border-bottom: 1px solid #e2e8f0;
      }

      .dropdown-search-input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 12px;
      }

      .dropdown-search-input:focus {
        outline: none;
        border-color: #ef4444;
      }

      .dropdown-search-icon {
        position: absolute;
        right: 16px;
        top: 16px;
        color: #718096;
        font-size: 12px;
      }

      .dropdown-content {
        max-height: 200px;
        overflow-y: auto;
        padding-top: 0;
      }
      /* tick button styles */
      .tick-btn {
        position: relative;
        overflow: hidden;
        font-weight: 500;
        user-select: none;
      }

      .tick-btn:active {
        transform: scale(0.98);
      }

      /* Active state for exclude zero buttons */
      .tick-btn.bg-red-500 {
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
      }

      /* Mobile-specific improvements */
      @media (max-width: 640px) {
        .tick-btn {
          font-size: 10px;
          padding: 6px 8px;
        }

        .tick-btn i {
          font-size: 9px;
        }
      }

      /* Smooth transitions for all interactive elements */
      .tick-btn,
      .pagination-btn,
      .filter-btn {
        transition: all 0.2s ease-in-out;
      }

      /* Better focus states for accessibility */
      .tick-btn:focus-within,
      input[type="checkbox"]:focus + .tick-btn {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
      }

      /* Loading state for buttons */
      .tick-btn.loading {
        opacity: 0.7;
        pointer-events: none;
      }

      /* Better responsive container */
      @media (max-width: 768px) {
        .bg-white.rounded-lg.shadow-sm {
          margin: 0 -0.5rem;
          border-radius: 0;
        }
      }

      /* Animation for active filter indicator */
      #active-exclude-filter {
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="bg-red-500 text-white p-2">
      <!-- Main header row -->
      <div class="flex items-center justify-between">
        <!-- Hamburger Icon with Dropdown -->
        <div class="relative">
          <button id="menuButton" class="text-xl p-2 focus:outline-none">
            <i class="fas fa-bars text-white"></i>
          </button>

          <!-- Dropdown Menu -->
          <div
            id="dropdownMenu"
            class="absolute left-[10px] mt-2 w-[250px] bg-white border rounded shadow-lg hidden z-50"
          >
            <a
              href="{% url 'stock' %}"
              class="flex items-center gap-3 px-4 py-4 hover:bg-gray-100 text-black text-red-500"
            >
              <i class="fa-solid fa-box-open text-red-500"></i>
              Stock Report
            </a>

            <a
              href="{% url 'transaction' %}"
              class="flex items-center gap-3 px-4 py-4 hover:bg-gray-100 text-black"
            >
              <i class="fa-solid fa-indian-rupee-sign text-red-500"></i>
              Transaction Details
            </a>
          </div>
        </div>

        <!-- Logo Container -->
        <div class="logo-container">
          <img src="{% static 'images\omegawhite.png' %}" alt="" />
        </div>

        <!-- Right side container -->
        <div class="flex flex-col gap-4 mt-3 items-end space-y-2 md:pr-18 pr-3">
          <!-- Buttons row -->
          <div class="flex items-center space-x-6 md:space-x-10">
            <a href="#" class="relative" id="filter-button">
              <i class="fas fa-filter text-xl"></i>
              <span
                id="filter-dot"
                class="hidden absolute -top-1 -right-1 w-2 h-2 bg-yellow-400 rounded-full"
              ></span>
            </a>
            <button id="logout-btn" class="text-white">
              <i class="fas fa-sign-out-alt text-xl"></i>
            </button>
          </div>

          <!-- Username row -->
          <div class="flex items-center space-x-2 text-white">
            <i class="fas fa-user text-sm"></i>
            <span id="username-display" class="text-sm font-medium">
              Loading...
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- Authentication Error Message -->
    <div id="auth-error" class="hidden error-message">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      Your session has expired. Please
      <a href="/login/" class="underline font-medium">login again</a>.
    </div>

    <!-- Company Dashboard Card -->
    <div
      class="dashboard-card rounded-2xl p-6 mb-6 text-white mt-5 md:mx-20 mx-3"
    >
      <div class="flex items-center justify-center mb-4">
        <h2 class="text-2xl font-bold text-center">Transaction Analytics</h2>
      </div>

      <!-- Quick Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 stats-grid">
        <div class="stats-card rounded-xl p-4 text-center">
          <div class="text-lg font-bold text-gray-800" id="total-transactions">
            ...
          </div>
          <div class="text-xs text-gray-600">Total Products</div>
        </div>
        <div class="stats-card rounded-xl p-4 text-center">
          <div class="text-lg font-bold text-green-600" id="total-sales">
            ...
          </div>
          <div class="text-xs text-gray-600">Total Sales Qty</div>
        </div>
        <div class="stats-card rounded-xl p-4 text-center">
          <div class="text-lg font-bold text-blue-600" id="total-production">
            ...
          </div>
          <div class="text-xs text-gray-600">Total Purchase Qty</div>
        </div>
        <div class="stats-card rounded-xl p-4 text-center">
          <div class="text-lg font-bold text-purple-600" id="total-product-qty">
            ...
          </div>
          <div class="text-xs text-gray-600">Total Production Qty</div>
        </div>
      </div>
    </div>

    <!-- Filter Panel -->
    <div
      id="filter-panel"
      class="hidden fixed top-16 right-5 shadow-xl bg-white rounded-lg z-10 w-64 border border-gray-200"
    >
      <div
        class="flex flex-col gap-2 justify-start item-start p-3 border-b border-gray-200 text-gray-700"
      >
        Filter By:
        <div
          id="selected-filters"
          class="flex flex-col gap-5 text-red-500 text-base ml-2 text-[16px] justify-start item-start"
        ></div>
      </div>
      <ul>
        <li
          class="px-4 py-3 cursor-pointer hover:bg-gray-50"
          id="all-products-filter"
        >
          <span>All Products</span>
        </li>
        <li
          class="px-4 py-3 cursor-pointer hover:bg-gray-50 relative"
          id="stock-category-filter"
        >
          <div class="flex items-center justify-between">
            <span>Stock Category</span>
            <i
              class="fas fa-chevron-down text-xs text-gray-400"
              id="category-arrow"
            ></i>
          </div>
          <div class="hidden mt-2 dropdown-content" id="category-dropdown">
            <div class="max-h-32 overflow-y-auto bg-gray-50 rounded">
              <div class="p-2 text-center text-gray-500">
                <div class="loading"></div>
              </div>
            </div>
          </div>
        </li>
        <li
          class="px-4 py-3 cursor-pointer hover:bg-gray-50 relative"
          id="product-filter"
        >
          <div class="flex items-center justify-between">
            <span>Product</span>
            <i
              class="fas fa-chevron-down text-xs text-gray-400"
              id="product-arrow"
            ></i>
          </div>

          <div class="hidden mt-2 dropdown-content" id="product-dropdown">
            <div class="max-h-32 overflow-y-auto bg-gray-50 rounded">
              <div class="p-2 text-center text-gray-500">
                <div class="loading"></div>
              </div>
            </div>
          </div>
        </li>
        <li
          class="px-4 py-3 cursor-pointer hover:bg-gray-50 relative"
          id="brand-filter"
        >
          <div class="flex items-center justify-between">
            <span>Brand</span>
            <i
              class="fas fa-chevron-down text-xs text-gray-400"
              id="brand-arrow"
            ></i>
          </div>
          <div class="hidden mt-2 dropdown-content" id="brand-dropdown">
            <div class="max-h-32 overflow-y-auto bg-gray-50 rounded">
              <div class="p-2 text-center text-gray-500">
                <div class="loading"></div>
              </div>
            </div>
          </div>
        </li>
      </ul>
      <div class="p-3 border-t border-gray-200 flex justify-end">
        <button class="text-red-500 font-medium text-sm" id="apply-filters-btn">
          Apply Filters
        </button>
      </div>
    </div>

    <!-- Date Range Selector -->
    <div class="p-3 bg-white md:mx-20 mx-2">
      <!-- Date inputs and search button in one row for mobile -->
      <div class="flex items-center space-x-2 mb-3">
        <!-- From Date -->
        <div class="flex-1">
          <div
            class="border border-red-300 rounded-full px-3 py-2 flex items-center"
          >
            <input
              type="text"
              id="from-date"
              placeholder="From Date"
              class="date-picker-input w-full bg-transparent focus:outline-none text-sm"
              readonly
            />
            <i class="fas fa-calendar ml-auto text-gray-400 text-sm"></i>
          </div>
        </div>

        <!-- To Date -->
        <div class="flex-1">
          <div
            class="border border-red-300 rounded-full px-3 py-2 flex items-center"
          >
            <input
              type="text"
              id="to-date"
              placeholder="To Date"
              class="date-picker-input w-full bg-transparent focus:outline-none text-sm"
              readonly
            />
            <i class="fas fa-calendar ml-auto text-gray-400 text-sm"></i>
          </div>
        </div>

        <!-- Search Icon Button -->
        <div
          class="bg-red-500 hover:bg-red-600 transition-colors p-2.5 rounded-full cursor-pointer"
          id="search-button"
        >
          <i class="fas fa-search text-white text-sm"></i>
        </div>
      </div>

      <!-- Search Input in separate row -->
      <div class="relative">
        <input
          type="text"
          placeholder="Search products.."
          class="search-input w-full py-3 pl-4 pr-10 border border-red-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white/80"
          id="search-input"
        />
        <button
          class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 transition-colors"
          id="text-search-button"
        >
          <i class="fas fa-search text-lg"></i>
        </button>
      </div>

      <!-- Tick Filter Buttons -->
      <div class="bg-white rounded-lg shadow-sm p-3 md:p-4 mb-4 mt-4">
        <div class="flex flex-col space-y-3">
          <!-- Title -->
          <div class="flex items-center justify-between">
            <h3 class="text-sm md:text-base font-medium text-gray-700">
              Exclude Zero Quantities
            </h3>
            <span class="text-xs text-gray-500 hidden md:inline"
              >Select one filter at a time</span
            >
          </div>

          <!-- Mobile hint -->
          <p class="text-xs text-gray-500 md:hidden">
            Tap to show only non-zero quantities
          </p>

          <!-- Filter buttons - always in one row now -->
          <div class="flex gap-1.5">
            <!-- Sales -->
            <label
              class="flex-1 flex items-center justify-center cursor-pointer"
            >
              <input
                type="checkbox"
                class="data-toggle-checkbox hidden"
                data-type="sales"
              />
              <span
                class="w-full text-center px-2 py-2 text-xs rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-red-50 hover:border-red-300 transition-all duration-200 tick-btn"
              >
                <i class="fas fa-chart-line mr-1"></i>
                Sales
              </span>
            </label>

            <!-- Purchase -->
            <label
              class="flex-1 flex items-center justify-center cursor-pointer"
            >
              <input
                type="checkbox"
                class="data-toggle-checkbox hidden"
                data-type="purchase"
              />
              <span
                class="w-full text-center px-2 py-2 text-xs rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-blue-50 hover:border-blue-300 transition-all duration-200 tick-btn"
              >
                <i class="fas fa-shopping-cart mr-1"></i>
                Purchase
              </span>
            </label>

            <!-- Production -->
            <label
              class="flex-1 flex items-center justify-center cursor-pointer"
            >
              <input
                type="checkbox"
                class="data-toggle-checkbox hidden"
                data-type="product"
              />
              <span
                class="w-full text-center px-2 py-2 text-xs rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-green-50 hover:border-green-300 transition-all duration-200 tick-btn"
              >
                <i class="fas fa-industry mr-1"></i>
                Production
              </span>
            </label>
          </div>

          <!-- Active filter indicator -->
          <div id="active-exclude-filter" class="hidden">
            <div class="bg-red-50 border-l-4 border-red-400 p-2 rounded">
              <div class="flex items-center">
                <i class="fas fa-filter text-red-400 mr-2"></i>
                <span class="text-sm text-red-700" id="active-filter-text"
                  >Showing non-zero values</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div class="px-4 py-8 text-center hidden" id="loading-indicator">
      <div class="loading mx-auto"></div>
      <p class="mt-2 text-gray-500">Loading transaction data...</p>
    </div>

    <!-- Transaction Table -->
    <div class="px-3 pb-6 md:mx-20 mx-2" id="table-container">
      <div class="table-container">
        <div class="table-header grid grid-cols-4 md:px-3">
          <div class="table-cell px-1 text-sm md:text-md text-center">
            Product Name
          </div>
          <div class="table-cell px-1 text-sm md:text-md text-center">
            Sales Qty
          </div>
          <div class="table-cell px-1 text-sm md:text-md text-center">
            Purchase Qty
          </div>
          <div class="table-cell px-1 text-sm md:text-md text-center">
            Production Qty
          </div>
        </div>

        <div id="transactions-table-body">
          <!-- Sample data for demonstration -->
          <div class="table-row grid grid-cols-4 hover:bg-gray-50">
            <div class="table-cell px-1 text-left">Product A</div>
            <div class="table-cell px-1">150</div>
            <div class="table-cell px-1">200</div>
            <div class="table-cell px-1">100</div>
          </div>
          <div class="table-row grid grid-cols-4 hover:bg-gray-50">
            <div class="table-cell px-1 text-left">Product B</div>
            <div class="table-cell px-1">75</div>
            <div class="table-cell px-1">120</div>
            <div class="table-cell px-1">80</div>
          </div>
          <div class="table-row grid grid-cols-4 hover:bg-gray-50">
            <div class="table-cell px-1 text-left">Product C</div>
            <div class="table-cell px-1">300</div>
            <div class="table-cell px-1">250</div>
            <div class="table-cell px-1">200</div>
          </div>
        </div>
      </div>
      <!-- Pagination Controls -->
      <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6 m-10">
        <div
          class="flex flex-col space-y-4 sm:space-y-0 sm:flex-row sm:items-center sm:justify-between"
        >
          <!-- Page size selector -->
          <div class="flex items-center space-x-2">
            <span class="text-sm">Show:</span>
            <select
              id="page-size-select"
              class="border rounded px-2 py-1 text-sm"
            >
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="text-sm">per page</span>
          </div>

          <!-- Pagination info -->
          <div class="text-sm text-center sm:text-left" id="pagination-info">
            Showing 1-3 of 3 results
          </div>

          <!-- Pagination buttons -->
          <div
            class="flex justify-center sm:justify-end"
            id="pagination-container"
          >
            <button class="pagination-btn" disabled>Previous</button>
            <button class="pagination-btn active">1</button>
            <button class="pagination-btn" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Results Message -->
    <div class="px-4 py-8 text-center hidden" id="no-results">
      <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
      <p class="text-gray-500">
        No transaction data found for the selected criteria.
      </p>
      <p class="text-gray-400 text-sm mt-2">
        Try adjusting your date range or filters.
      </p>
    </div>

    <!-- Date Range Info -->
    <div
      class="px-4 py-2 text-center text-gray-500 text-sm hidden"
      id="date-range-info"
    >
      <i class="fas fa-info-circle mr-1"></i>
      <span id="date-range-text"
        >Please select a date range to view transactions</span
      >
    </div>

    <!-- JavaScript for Date Pickers and API Integration -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      // Global variables
      let stockCategories = [];
      let products = [];
      let brands = [];
      let currentFilters = {
        stockCategory: null,
        product: null,
        brand: null,
      };
      let fromDatePicker, toDatePicker;
      let allTransactionData = [];
      let currentPage = 1;
      let pageSize = 10;
      let isDateFiltered = false;
      let originalTransactionData = [];

      let excludeZeroFilters = {
        sales: false,
        purchase: false,
        product: false,
      };
      // API Base URL
      //const API_BASE_URL = "http://127.0.0.1:8000/api";
      const API_BASE_URL = "https://test.imcbs.com";

      // Authentication utilities
      function getAuthToken() {
        const token = localStorage.getItem("omega-token");
        if (!token) {
          showAuthError();
          return null;
        }
        return token;
      }

      function getUsername() {
        const userName = localStorage.getItem("omega-userId");
        if (!userName) {
          showAuthError();
          return null;
        }
        return userName;
      }

      function getAuthHeaders() {
        const token = getAuthToken();
        if (!token) return null;

        return {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };
      }

      function showAuthError() {
        document.getElementById("auth-error").classList.remove("hidden");
        document.getElementById("table-container").classList.add("hidden");
        document.getElementById("loading-indicator").classList.add("hidden");
        document.getElementById("date-range-info").classList.add("hidden");
      }

      function hideAuthError() {
        document.getElementById("auth-error").classList.add("hidden");
      }

      function handleAuthError() {
        localStorage.removeItem("token");
        showAuthError();
      }

      function logout() {
        localStorage.removeItem("omega-token");
        localStorage.removeItem("omega-userId");
        window.location.href = "/login/";
      }

      // Enhanced fetch function with authentication
      async function authenticatedFetch(url, options = {}) {
        const headers = getAuthHeaders();
        if (!headers) {
          throw new Error("No authentication token");
        }

        const response = await fetch(url, {
          ...options,
          headers: {
            ...headers,
            ...options.headers,
          },
        });

        if (response.status === 401 || response.status === 403) {
          handleAuthError();
          throw new Error("Authentication failed");
        }

        return response;
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        // Check if user is authenticated
        if (!getAuthToken()) {
          showAuthError();
          return;
        }

        hideAuthError();
        initializeDashboard();
        initializeDatePickers();
        loadInitialData();
        setupEventListeners();
        showInitialMessage();
      });

      function initializeDatePickers() {
        // Initialize From Date picker
        fromDatePicker = flatpickr("#from-date", {
          dateFormat: "Y-m-d",
          maxDate: "today",
          onChange: function (selectedDates, dateStr, instance) {
            // Update To Date picker minDate
            if (toDatePicker && dateStr) {
              toDatePicker.set("minDate", dateStr);
            }
            updateDateRangeInfo();
          },
        });

        // Initialize To Date picker
        toDatePicker = flatpickr("#to-date", {
          dateFormat: "Y-m-d",
          maxDate: "today",
          onChange: function (selectedDates, dateStr, instance) {
            // Update From Date picker maxDate
            if (fromDatePicker && dateStr) {
              fromDatePicker.set("maxDate", dateStr);
            }
            updateDateRangeInfo();
          },
        });
      }

      // Initialize username display when page loads
      document.addEventListener("DOMContentLoaded", function () {
        const usernameDisplay = document.getElementById("username-display");

        if (usernameDisplay) {
          const username = getUsername();
          if (username) {
            usernameDisplay.textContent = username;
          } else {
            usernameDisplay.textContent = "Guest";
          }
        }
      });

      function setupEventListeners() {
        // Logout button
        document
          .getElementById("logout-btn")
          .addEventListener("click", function (event) {
            const confirmLogout = confirm("Are you sure you want to logout?");
            if (confirmLogout) {
              localStorage.removeItem("token");
              window.location.href = "/login/";
            }
            // else: do nothing
          });

        ["stock-category-filter", "product-filter", "brand-filter"].forEach(
          (id) => {
            document.getElementById(id).addEventListener("click", (e) => {
              e.stopPropagation();
              if (e.target.closest(".dropdown-content")) return;

              // ✅ Fix the key mapping
              const keyMap = {
                "stock-category-filter": "category",
                "product-filter": "product",
                "brand-filter": "brand",
              };

              const key = keyMap[id];
              toggleDropdown(key);
            });
          }
        );

        // Filter panel toggle
        document
          .getElementById("filter-button")
          .addEventListener("click", toggleFilterPanel);

        // All products filter
        document
          .getElementById("all-products-filter")
          .addEventListener("click", () => {
            clearAllFilters();
            if (hasValidDateRange()) {
              loadTransactionsByDate();
            } else {
              loadTransactionSummary();
            }
            toggleFilterPanel();
          });

        // Apply filters button
        document
          .getElementById("apply-filters-btn")
          .addEventListener("click", () => {
            if (hasValidDateRange()) {
              loadTransactionsByDate();
            } else {
              loadTransactionSummary();
            }
            toggleFilterPanel();
          });

        // Search functionality
        // Text search input
        document
          .getElementById("search-input")
          .addEventListener("input", handleSearch);
        document
          .getElementById("text-search-button")
          .addEventListener("click", handleSearch);

        // Page size selector
        document
          .getElementById("page-size-select")
          .addEventListener("change", function (e) {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            updatePaginatedTransactions();
          });
        setupExcludeZeroEventListeners();
      }
      document.getElementById("search-button").addEventListener("click", () => {
        if (hasValidDateRange()) {
          loadTransactionsByDate();
        } else {
          showError("Please select both from and to dates.");
        }
      });

      function hasValidDateRange() {
        const fromDate = document.getElementById("from-date").value;
        const toDate = document.getElementById("to-date").value;
        return fromDate && toDate;
      }

      function updateDateRangeInfo() {
        const fromDate = document.getElementById("from-date").value;
        const toDate = document.getElementById("to-date").value;
        const dateRangeInfo = document.getElementById("date-range-info");
        const dateRangeText = document.getElementById("date-range-text");

        if (fromDate && toDate) {
          dateRangeText.textContent = `Showing data from ${fromDate} to ${toDate}`;
          dateRangeInfo.classList.remove("hidden");
        } else if (fromDate || toDate) {
          dateRangeText.textContent = "Please select both start and end dates";
          dateRangeInfo.classList.remove("hidden");
        } else {
          dateRangeInfo.classList.add("hidden");
        }
      }

      function showInitialMessage() {
        document.getElementById("date-range-info").classList.remove("hidden");
        document.getElementById("date-range-text").textContent =
          "Select a date range above to view transactions, or load all product summaries";
      }

      async function loadInitialData() {
        try {
          // Load filter options
          await Promise.all([
            loadStockCategories(),
            loadProductsList(),
            loadBrands(),
          ]);

          // Load initial transaction summary (without date filter)
          await loadTransactionSummary();
        } catch (error) {
          console.error("Error loading initial data:", error);
          if (
            error.message === "Authentication failed" ||
            error.message === "No authentication token"
          ) {
            return;
          }
          showError("Failed to load initial data. Please try again.");
        }
      }
      async function loadTransactionSummary() {
        showLoading();
        isDateFiltered = false;

        // Clear search input when loading new data
        document.getElementById("search-input").value = "";

        try {
          let url = `${API_BASE_URL}/product-summary/`;
          const params = new URLSearchParams();

          if (currentFilters.stockCategory) {
            params.append("stockCategory", currentFilters.stockCategory);
          }
          if (currentFilters.product) {
            params.append("product", currentFilters.product);
          }
          if (currentFilters.brand) {
            params.append("brand", currentFilters.brand);
          }

          if (params.toString()) {
            url += "?" + params.toString();
          }

          const response = await authenticatedFetch(url);
          const data = await response.json();

          if (data.success) {
            originalTransactionData = data.data; // Store original data
            allTransactionData = [...originalTransactionData]; // Set working data
            updatePaginatedTransactions();
            updatePaginationControls();
          } else {
            throw new Error(data.error || "Failed to load transaction summary");
          }
        } catch (error) {
          console.error("Error loading transaction summary:", error);
          if (
            error.message === "Authentication failed" ||
            error.message === "No authentication token"
          ) {
            return;
          }
          showError("Failed to load transaction data. Please try again.");
        } finally {
          hideLoading();
        }
      }

      async function loadTransactionsByDate() {
        const fromDate = document.getElementById("from-date").value;
        const toDate = document.getElementById("to-date").value;

        if (!fromDate || !toDate) {
          showError("Please select both from and to dates.");
          return;
        }

        showLoading();
        isDateFiltered = true;

        // Clear search input when loading new data
        document.getElementById("search-input").value = "";

        try {
          let url = `${API_BASE_URL}/product-summary-by-date/`;
          const params = new URLSearchParams();

          params.append("fromDate", fromDate);
          params.append("toDate", toDate);

          if (currentFilters.stockCategory) {
            params.append("stockCategory", currentFilters.stockCategory);
          }
          if (currentFilters.product) {
            params.append("product", currentFilters.product);
          }
          if (currentFilters.brand) {
            params.append("brand", currentFilters.brand);
          }

          url += "?" + params.toString();

          const response = await authenticatedFetch(url);
          const data = await response.json();

          if (data.success) {
            originalTransactionData = data.data; // Store original data
            allTransactionData = [...originalTransactionData]; // Set working data
            updatePaginatedTransactions();
            updatePaginationControls();
          } else {
            throw new Error(
              data.error || "Failed to load transaction data by date"
            );
          }
        } catch (error) {
          console.error("Error loading transactions by date:", error);
          if (
            error.message === "Authentication failed" ||
            error.message === "No authentication token"
          ) {
            return;
          }
          showError("Failed to load transaction data. Please try again.");
        } finally {
          hideLoading();
        }
      }

      function handleSearch() {
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase()
          .trim();

        if (searchTerm === "") {
          // If search is empty, restore original data
          allTransactionData = [...originalTransactionData];
        } else {
          // Filter the original data
          allTransactionData = originalTransactionData.filter((transaction) => {
            const productName = transaction.name
              ? transaction.name.toLowerCase()
              : "";
            return productName.includes(searchTerm);
          });
        }

        currentPage = 1; // Reset to first page
        updatePaginatedTransactions();
      }

      function updatePaginatedTransactions() {
        // Apply exclude zero filters before pagination
        let filteredData = [...allTransactionData];

        // Check if any exclude zero filter is active
        const hasExcludeFilter =
          excludeZeroFilters.sales ||
          excludeZeroFilters.purchase ||
          excludeZeroFilters.product;

        // Apply exclude zero filters
        if (hasExcludeFilter) {
          filteredData = filteredData.filter((transaction) => {
            const salesQty = isDateFiltered
              ? transaction.sales_quantity || 0
              : transaction.inv_quantity || 0;
            const purchaseQty = isDateFiltered
              ? transaction.purchase_quantity || 0
              : transaction.purchase_quantity || 0;
            const productionQty = isDateFiltered
              ? transaction.production_quantity || 0
              : transaction.production_quantity || 0;

            if (excludeZeroFilters.sales) {
              return salesQty > 0;
            }
            if (excludeZeroFilters.purchase) {
              return purchaseQty > 0;
            }
            if (excludeZeroFilters.product) {
              return productionQty > 0;
            }

            return true;
          });
        }

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const paginated = filteredData.slice(start, end);

        // Update dashboard with filtered data (not just paginated)
        updateDashboardStats(filteredData, isDateFiltered);

        // Display only paginated data in table
        displayPaginatedTable(paginated, isDateFiltered);

        // Update pagination info with filtered count
        updatePaginationControlsWithFilteredData(filteredData.length);
      }

      // Add new function for pagination with filtered data
      function updatePaginationControlsWithFilteredData(filteredTotal) {
        const container = document.getElementById("pagination-container");
        const info = document.getElementById("pagination-info");

        const totalPages = Math.ceil(filteredTotal / pageSize);

        const start =
          filteredTotal === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, filteredTotal);
        info.textContent = `Showing ${start}-${end} of ${filteredTotal} results`;

        container.innerHTML = "";

        if (totalPages <= 1) return;

        const createBtn = (text, page, active = false, disabled = false) => {
          const btn = document.createElement("button");
          btn.className = `pagination-btn ${active ? "active" : ""}`;
          btn.textContent = text;
          btn.disabled = disabled;
          if (!disabled) {
            btn.addEventListener("click", () => {
              currentPage = page;
              updatePaginatedTransactions();
            });
          }
          return btn;
        };

        // Previous
        container.appendChild(
          createBtn("←", currentPage - 1, false, currentPage === 1)
        );

        // Pages
        const maxPages = 3;
        let startPage = Math.max(1, currentPage - 1);
        let endPage = Math.min(startPage + maxPages - 1, totalPages);
        for (let i = startPage; i <= endPage; i++) {
          container.appendChild(createBtn(i, i, i === currentPage));
        }

        // Next
        container.appendChild(
          createBtn("→", currentPage + 1, false, currentPage === totalPages)
        );
      }

      function updatePaginationControls() {
        const container = document.getElementById("pagination-container");
        const info = document.getElementById("pagination-info");

        const total = allTransactionData.length;
        const totalPages = Math.ceil(total / pageSize);

        const start = total === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, total);
        info.textContent = `Showing ${start}-${end} of ${total} results`;

        container.innerHTML = "";

        if (totalPages <= 1) return;

        const createBtn = (text, page, active = false, disabled = false) => {
          const btn = document.createElement("button");
          btn.className = `pagination-btn ${active ? "active" : ""}`;
          btn.textContent = text;
          btn.disabled = disabled;
          if (!disabled) {
            btn.addEventListener("click", () => {
              currentPage = page;
              updatePaginatedTransactions();
              updatePaginationControls();
            });
          }
          return btn;
        };

        // Previous
        container.appendChild(
          createBtn("←", currentPage - 1, false, currentPage === 1)
        );

        // Pages
        const maxPages = 3;
        let startPage = Math.max(1, currentPage - 1);
        let endPage = Math.min(startPage + maxPages - 1, totalPages);
        for (let i = startPage; i <= endPage; i++) {
          container.appendChild(createBtn(i, i, i === currentPage));
        }

        // Next
        container.appendChild(
          createBtn("→", currentPage + 1, false, currentPage === totalPages)
        );
      }

      // Dashboard functions
      function initializeDashboard() {
        document.getElementById("total-transactions").textContent = "...";
        document.getElementById("total-sales").textContent = "...";
        document.getElementById("total-production").textContent = "...";
        document.getElementById("total-product-qty").textContent = "...";
      }

      function updateDashboardStats(transactionsData, isDateFiltered) {
        if (!transactionsData || transactionsData.length === 0) {
          // Reset to zero if no data
          document.getElementById("total-transactions").textContent = "0";
          document.getElementById("total-sales").textContent = "0";
          document.getElementById("total-production").textContent = "0";
          document.getElementById("total-product-qty").textContent = "0";
          return;
        }

        // Calculate totals
        let totalProducts = transactionsData.length;
        let totalSales = 0;
        let totalPurchase = 0;
        let totalProductQty = 0;

        transactionsData.forEach((transaction) => {
          // Handle different field names based on data source
          const salesQty = isDateFiltered
            ? transaction.sales_quantity || 0
            : transaction.inv_quantity || 0;

          const purchaseQty = isDateFiltered
            ? transaction.purchase_quantity || 0
            : transaction.purchase_quantity || 0;

          const productionQty = isDateFiltered
            ? transaction.production_quantity || 0
            : transaction.production_quantity || 0;

          totalSales += Number(salesQty);
          totalPurchase += Number(purchaseQty);
          totalProductQty += Number(productionQty);
        });

        // Update dashboard elements with animated counting effect
        animateNumber("total-transactions", totalProducts);
        animateNumber("total-sales", Math.round(totalSales));
        animateNumber("total-production", Math.round(totalPurchase));
        animateNumber("total-product-qty", Math.round(totalProductQty));
      }

      // Animated number counting function
      function animateNumber(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const startValue = parseInt(element.textContent) || 0;
        const duration = 1000; // 1 second
        const startTime = Date.now();

        function updateNumber() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // Easing function for smooth animation
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const currentValue = Math.round(
            startValue + (targetValue - startValue) * easeOut
          );

          element.textContent = currentValue.toLocaleString();

          if (progress < 1) {
            requestAnimationFrame(updateNumber);
          }
        }

        requestAnimationFrame(updateNumber);
      }

      // Table display functions
      function displayPaginatedTable(transactionsData, isDateFiltered) {
        const tableBody = document.getElementById("transactions-table-body");
        const noResults = document.getElementById("no-results");
        const tableContainer = document.getElementById("table-container");

        if (!transactionsData || transactionsData.length === 0) {
          tableContainer.classList.add("hidden");
          noResults.classList.remove("hidden");
          return;
        }

        tableContainer.classList.remove("hidden");
        noResults.classList.add("hidden");

        tableBody.innerHTML = "";

        transactionsData.forEach((transaction, index) => {
          const row = document.createElement("div");
          row.className = `table-row grid grid-cols-4 ${
            index % 2 === 0 ? "" : "bg-gray-50"
          }`;

          const salesQty = isDateFiltered
            ? transaction.sales_quantity || 0
            : transaction.inv_quantity || 0;
          const purchaseQty = isDateFiltered
            ? transaction.purchase_quantity || 0
            : transaction.purchase_quantity || 0;
          const productionQty = isDateFiltered
            ? transaction.production_quantity || 0
            : transaction.production_quantity || 0;

          const isHighActivity =
            salesQty > 50 || purchaseQty > 50 || productionQty > 1000;
          if (isHighActivity) {
            row.className += " highlight-row";
          }

          row.innerHTML = `
      <div class="table-cell col-product ${
        isHighActivity ? "highlight-text" : ""
      }">${transaction.name || "N/A"}</div>
      <div class="table-cell col-sales ${
        isHighActivity ? "highlight-text" : ""
      }">${Math.round(salesQty).toLocaleString()}</div>
      <div class="table-cell col-purchase ${
        isHighActivity ? "highlight-text" : ""
      }">${Math.round(purchaseQty).toLocaleString()}</div>
      <div class="table-cell col-production ${
        isHighActivity ? "highlight-text" : ""
      }">${Math.round(productionQty).toLocaleString()}</div>
    `;

          tableBody.appendChild(row);
        });
      }
      async function loadStockCategories() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE_URL}/stock-categories/`
          );
          const data = await response.json();

          if (data.success) {
            stockCategories = data.data;
            populateDropdown("category", stockCategories);
          }
        } catch (error) {
          console.error("Error loading stock categories:", error);
        }
      }

      async function loadProductsList() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE_URL}/products-list/`
          );
          const data = await response.json();

          if (data.success) {
            products = data.data;
            populateDropdown("product", products);
          }
        } catch (error) {
          console.error("Error loading products list:", error);
        }
      }

      async function loadBrands() {
        try {
          const response = await authenticatedFetch(`${API_BASE_URL}/brands/`);
          const data = await response.json();

          if (data.success) {
            brands = data.data;
            populateDropdown("brand", brands);
          }
        } catch (error) {
          console.error("Error loading brands:", error);
        }
      }

      function populateDropdown(type, items) {
        const dropdownId = `${type}-dropdown`;
        const dropdown = document.getElementById(dropdownId);

        if (!dropdown) return;

        // Clear existing dropdown
        dropdown.innerHTML = "";

        // Add search container
        const searchContainer = document.createElement("div");
        searchContainer.className = "dropdown-search-container";
        searchContainer.innerHTML = `
    <div style="position: relative;">
      <input type="text" placeholder="Search ${type}..." 
             class="dropdown-search-input" 
             id="${type}-search-input">
      <i class="fas fa-search dropdown-search-icon"></i>
    </div>
  `;
        dropdown.appendChild(searchContainer);

        // Add items container
        const itemsContainer = document.createElement("div");
        itemsContainer.id = `${type}-items-container`;
        dropdown.appendChild(itemsContainer);

        // Function to render filtered items
        const renderItems = (filteredItems) => {
          itemsContainer.innerHTML = "";
          filteredItems.forEach((item) => {
            const div = document.createElement("div");
            div.className =
              "px-3 py-2 cursor-pointer hover:bg-gray-200 text-sm";
            div.textContent = item;
            if (currentFilters[type] === item)
              div.classList.add("filter-selected");
            div.addEventListener("click", () => selectFilter(type, item));
            itemsContainer.appendChild(div);
          });
        };

        // Initial render of all items
        renderItems(items);

        // Add search functionality
        const searchInput = document.getElementById(`${type}-search-input`);
        searchInput.addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filteredItems = items.filter((item) =>
            item.toLowerCase().includes(searchTerm)
          );
          renderItems(filteredItems);
        });
      }

      function selectFilter(type, value) {
        if (type === "category") {
          currentFilters.stockCategory = value;
        } else if (type === "product") {
          currentFilters.product = value;
        } else if (type === "brand") {
          currentFilters.brand = value;
        }

        updateFilterIndicator();

        // Close the dropdown
        document.getElementById(`${type}-dropdown`).classList.add("hidden");
        document
          .getElementById(`${type}-arrow`)
          .classList.remove("fa-chevron-up");
        document
          .getElementById(`${type}-arrow`)
          .classList.add("fa-chevron-down");

        // Add this line to refresh the dropdown to show selected item in red
        populateDropdown(
          type,
          type === "category"
            ? stockCategories
            : type === "product"
            ? products
            : brands
        );
      }

      function clearAllFilters() {
        currentFilters = {
          stockCategory: null,
          product: null,
          brand: null,
        };
        updateFilterIndicator();
      }

      function updateFilterIndicator() {
        const filterDot = document.getElementById("filter-dot");
        const selectedFiltersSpan = document.getElementById("selected-filters");
        const { stockCategory, product, brand } = currentFilters;

        const hasFilters = stockCategory || product || brand;

        if (hasFilters) {
          filterDot.classList.remove("hidden");

          const selected = [];
          if (stockCategory)
            selected.push(
              `<div><strong>Stock Category:</strong> ${stockCategory}</div>`
            );
          if (product)
            selected.push(`<div><strong>Product:</strong> ${product}</div>`);
          if (brand)
            selected.push(`<div><strong>Brand:</strong> ${brand}</div>`);

          selectedFiltersSpan.innerHTML = selected.join("");
        } else {
          filterDot.classList.add("hidden");
          selectedFiltersSpan.textContent = "";
        }
      }

      function toggleFilterPanel() {
        const filterPanel = document.getElementById("filter-panel");
        filterPanel.classList.toggle("hidden");
      }

      function toggleDropdown(type) {
        const dropdown = document.getElementById(`${type}-dropdown`);
        const arrow = document.getElementById(`${type}-arrow`);

        dropdown.classList.toggle("hidden");

        if (dropdown.classList.contains("hidden")) {
          arrow.classList.remove("fa-chevron-up");
          arrow.classList.add("fa-chevron-down");
        } else {
          arrow.classList.remove("fa-chevron-down");
          arrow.classList.add("fa-chevron-up");
        }
      }

      function showLoading() {
        document.getElementById("loading-indicator").classList.remove("hidden");
        document.getElementById("table-container").classList.add("hidden");
        document.getElementById("no-results").classList.add("hidden");
      }

      function hideLoading() {
        document.getElementById("loading-indicator").classList.add("hidden");
      }

      function showError(message) {
        alert(message); // You can replace this with a more elegant error display
      }

      // Close filter panel when clicking outside
      document.addEventListener("click", function (event) {
        const filterPanel = document.getElementById("filter-panel");
        const filterButton = document.getElementById("filter-button");

        if (
          !filterPanel.contains(event.target) &&
          !filterButton.contains(event.target)
        ) {
          filterPanel.classList.add("hidden");
        }
      });

      // Hamburger drop down
      document.addEventListener("DOMContentLoaded", function () {
        const menuButton = document.getElementById("menuButton");
        const dropdownMenu = document.getElementById("dropdownMenu");

        menuButton.addEventListener("click", function (e) {
          e.stopPropagation(); // Prevents event bubbling
          dropdownMenu.classList.toggle("hidden");
        });

        document.addEventListener("click", function (e) {
          if (
            !menuButton.contains(e.target) &&
            !dropdownMenu.contains(e.target)
          ) {
            dropdownMenu.classList.add("hidden");
          }
        });
      });

      // Check box functionality
      function setupExcludeZeroEventListeners() {
        // Get all exclude zero checkboxes
        const excludeCheckboxes = document.querySelectorAll(
          ".data-toggle-checkbox"
        );

        excludeCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const type = this.dataset.type;
            const isChecked = this.checked;

            // If this checkbox is being checked, uncheck others
            if (isChecked) {
              excludeZeroFilters = {
                sales: false,
                purchase: false,
                product: false,
              };

              // Uncheck all other checkboxes and update their UI
              excludeCheckboxes.forEach((otherCheckbox) => {
                if (otherCheckbox !== this) {
                  otherCheckbox.checked = false;
                  updateExcludeZeroUI(otherCheckbox.dataset.type, false);
                }
              });

              // Set current filter
              excludeZeroFilters[type] = true;
              updateExcludeZeroUI(type, true);

              // Show active filter indicator
              showActiveFilterIndicator(type);
            } else {
              // If unchecking, just remove this filter
              excludeZeroFilters[type] = false;
              updateExcludeZeroUI(type, false);

              // Hide active filter indicator
              document
                .getElementById("active-exclude-filter")
                .classList.add("hidden");
            }

            // Refresh data based on current state
            refreshDataWithFilters();
          });
        });

        // Add event listener for clear button
        const clearBtn = document.getElementById("clear-exclude-filter-btn");
        if (clearBtn) {
          clearBtn.addEventListener("click", clearExcludeZeroFilters);
        }
      }

      // Add function to show active filter indicator
      function showActiveFilterIndicator(type) {
        const indicator = document.getElementById("active-exclude-filter");
        const textElement = document.getElementById("active-filter-text");

        const typeNames = {
          sales: "Sales",
          purchase: "Purchase",
          product: "Production",
        };

        textElement.textContent = `Showing non-zero ${typeNames[type]} quantities only`;
        indicator.classList.remove("hidden");
      }

      function updateExcludeZeroUI(type, isActive) {
        const checkbox = document.querySelector(`[data-type="${type}"]`);
        const tickBtn = checkbox.nextElementSibling;

        if (isActive) {
          tickBtn.classList.remove(
            "bg-white",
            "text-gray-700",
            "border-gray-300"
          );
          tickBtn.classList.add("bg-red-500", "border-red-500");
        } else {
          tickBtn.classList.remove(
            "bg-red-500",
            "text-white",
            "border-red-500"
          );
          tickBtn.classList.add("bg-white", "text-gray-700", "border-gray-300");
        }
      }

      function refreshDataWithFilters() {
        // Clear search input when applying new filters
        document.getElementById("search-input").value = "";

        if (hasValidDateRange()) {
          loadTransactionsByDate();
        } else {
          loadTransactionSummary();
        }
      }
      // Add this new function to clear exclude zero filters
      function clearExcludeZeroFilters() {
        // Reset all exclude zero filters
        excludeZeroFilters = {
          sales: false,
          purchase: false,
          product: false,
        };

        // Uncheck all checkboxes and update UI
        const excludeCheckboxes = document.querySelectorAll(
          ".data-toggle-checkbox"
        );
        excludeCheckboxes.forEach((checkbox) => {
          checkbox.checked = false;
          updateExcludeZeroUI(checkbox.dataset.type, false);
        });

        // Hide the active filter indicator
        document
          .getElementById("active-exclude-filter")
          .classList.add("hidden");

        // Refresh data
        refreshDataWithFilters();
      }
    </script>
  </body>
</html>
